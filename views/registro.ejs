<%- include('partials/header') %>
<h1>Registro de Pesaje</h1>

<!-- ========================= -->
<!-- ======== TARA ========== -->
<!-- ========================= -->
<form action="/confirmar-tara" method="post" id="formTara" style="display:<%= pesadaPara==='TARA' ? 'block':'none' %>">
  <div class="form-group">
    <label for="idTicket">ID Ticket</label>
    <input type="text" id="idTicket" name="idTicket" class="form-control" value="<%= newIdTicket %>" readonly>
  </div>

  <div class="form-group">
    <label for="fecha">Fecha</label>
    <input type="date" id="fecha" name="fecha" class="form-control" value="<%= new Date().toISOString().split('T')[0] %>" readonly>
  </div>

  <div class="form-group">
    <label for="usuario">Usuario</label>
    <input type="text" id="usuario" name="usuario" class="form-control" value="<%= ultimoUsuario %>" required>
  </div>

  <div class="form-group">
    <label for="cargaPara">Carga para</label>
    <select id="cargaPara" name="cargaPara" class="form-control" required onchange="toggleSocio()">
      <option value="">Seleccione</option>
      <option value="AMH">AMH</option>
      <option value="SOCIO">SOCIO</option>
    </select>
  </div>

  <div id="socioField" class="form-group" style="display:none;">
    <label for="socio">Nombre del Socio</label>
    <input type="text" id="socio" name="socio" class="form-control">
  </div>

  <div class="form-group">
    <label for="pesadaPara">Pesada para</label>
    <!-- IMPORTANTE: ahora hay 3 opciones -->
    <select id="pesadaPara" name="pesadaPara" class="form-control" required onchange="toggleForm()">
      <option value="">Seleccione</option>
      <option value="TARA"       <%= pesadaPara==='TARA' ? 'selected':'' %>>TARA</option>
      <option value="TARA_FINAL" <%= pesadaPara==='TARA_FINAL' ? 'selected':'' %>>TARA FINAL</option>
      <option value="REGULADA"   <%= pesadaPara==='REGULADA' ? 'selected':'' %>>REGULADA</option>
    </select>
  </div>

  <div class="form-group">
    <label for="transporte">Transporte</label>
    <input type="text" id="transporte" name="transporte" class="form-control" required>
  </div>

  <div class="form-group">
    <label for="patentes">Patentes</label>
    <input type="text" id="patentes" name="patentes" class="form-control" required>
  </div>

  <div class="form-group">
    <label for="chofer">Chofer</label>
    <input type="text" id="chofer" name="chofer" class="form-control" required>
  </div>

  <div class="form-group">
    <label for="brutoEstimadoTara">Bruto Estimado (kg)</label>
    <select id="brutoEstimadoTara" name="brutoEstimado" class="form-control" required>
      <option value="">Seleccione</option>
      <option value="45000">45000 kg</option>
      <option value="52500">52500 kg</option>
      <option value="55000">55000 kg</option>
    </select>
  </div>

  <!-- Tara (kg) - OPCIONAL en el primer paso -->
  <div class="mb-3">
    <label for="tara" class="form-label">Tara (kg)</label>
    <input
      type="number"
      id="tara"
      name="tara"
      class="form-control"
      min="0"
      step="1"
      placeholder="Podés dejarlo vacío si aún no la sabés"
      value="<%= typeof tara !== 'undefined' ? tara : '' %>"
    />
    <div class="form-text">
      Este campo es opcional al crear la TARA. Podés cargarlo después en <strong>TARA FINAL</strong> o al cerrar la <strong>REGULADA</strong>.
    </div>
  </div>

  <input type="hidden" name="code" value="<%= code %>">
  <button type="submit" class="btn btn-primary">Confirmar</button>
</form>

<!-- ============================== -->
<!-- ======== TARA FINAL ========= -->
<!-- ============================== -->
<form action="/confirmar-tara-final" method="post" id="formTaraFinal" style="display:<%= pesadaPara==='TARA_FINAL' ? 'block':'none' %>">
  <div class="alert alert-info">
    Cerrás la <strong>TARA</strong> de un ticket pendiente (NO cierra la REGULADA).  
    Elegí la patente y cargá la <strong>Tara definitiva</strong>.
  </div>

  <div class="form-group">
    <label for="patentesTF">Patentes con TARA pendiente (últimos 3 días)</label>
    <select id="patentesTF" name="patentes" class="form-control" required>
      <option value="">Seleccione</option>
      <% (pendientesTara || []).forEach(reg => { %>
        <option value="<%= reg.patentes %>" data-bruto="<%= reg.brutoEstimado %>" data-tara="<%= reg.tara %>">
          <%= reg.patentes %> (Bruto Est.: <%= reg.brutoEstimado %>, Tara actual: <%= reg.tara ?? '—' %>)
        </option>
      <% }) %>
    </select>
    <% if (!(pendientesTara && pendientesTara.length)) { %>
      <small class="text-muted">No hay TARA pendientes de los últimos 3 días.</small>
    <% } %>
  </div>

  <div class="row">
    <div class="col-md-6">
      <div class="form-group">
        <label for="brutoEstimadoTF">Bruto Estimado (kg)</label>
        <input type="text" id="brutoEstimadoTF" class="form-control" readonly>
      </div>
    </div>
    <div class="col-md-6">
      <div class="form-group">
        <label for="taraActualTF">Tara actual (si hubiera)</label>
        <input type="text" id="taraActualTF" class="form-control" readonly>
      </div>
    </div>
  </div>

  <div class="form-group">
    <label for="taraNueva">Tara NUEVA (kg)</label>
    <input type="number" id="taraNueva" name="taraNueva" class="form-control" min="0" step="1" required>
  </div>

  <input type="hidden" name="code" value="<%= code %>">
  <button type="submit" class="btn btn-primary">Confirmar</button>
</form>

<!-- ============================= -->
<!-- ======== REGULADA ========= -->
<!-- ============================= -->
<form action="/confirmar-regulada" method="post" id="formRegulada" style="display:<%= pesadaPara==='REGULADA' ? 'block':'none' %>">
  <div class="form-group">
    <label for="patentesRegulada">Patentes (pendientes: últimos 3 días)</label>
    <select id="patentesRegulada" name="patentes" class="form-control" required>
      <option value="">Seleccione</option>
      <% (pendientesTara || []).forEach(reg => { %>
        <option value="<%= reg.patentes %>" data-bruto="<%= reg.brutoEstimado %>" data-tara="<%= reg.tara %>">
          <%= reg.patentes %> (Bruto: <%= reg.brutoEstimado %>)
        </option>
      <% }) %>
    </select>
    <% if (!(pendientesTara && pendientesTara.length)) { %>
      <small class="text-muted">No hay TARA pendientes de los últimos 3 días.</small>
    <% } %>
  </div>

  <div class="form-group">
    <label for="campo">Campo</label>
    <select id="campo" name="campo" class="form-control" required>
      <option value="">Seleccione un campo</option>
      <% (campos || []).forEach(c => { %>
        <option value="<%= c %>"><%= c %></option>
      <% }) %>
    </select>
  </div>

  <div class="form-group">
    <label for="grano">Grano / Cultivo</label>
    <select id="grano" name="grano" class="form-control" required disabled>
      <option value="">Seleccione un cultivo</option>
    </select>
  </div>

  <div class="form-group">
    <label for="lote">Lote</label>
    <select id="lote" name="lote" class="form-control" required disabled>
      <option value="">Seleccione un lote</option>
    </select>
  </div>

  <div class="form-group">
    <label for="cargoDe">Cargo de</label>
    <select id="cargoDe" name="cargoDe" class="form-control" required onchange="toggleCargo()">
      <option value="">Seleccione</option>
      <option value="SILOBOLSA">Silobolsa</option>
      <option value="CONTRATISTA">Contratista</option>
    </select>
  </div>

  <div id="silobolsaField" class="form-group" style="display:none;">
    <label for="silobolsa">Número Silobolsa</label>
    <input type="text" id="silobolsa" name="silobolsa" class="form-control">
  </div>

  <div id="contratistaField" class="form-group" style="display:none;">
    <label for="contratista">Nombre Contratista</label>
    <input type="text" id="contratista" name="contratista" class="form-control">
  </div>

  <div class="form-group">
    <label for="brutoEstimadoReg">Bruto Estimado (kg)</label>
    <input type="text" id="brutoEstimadoReg" name="brutoEstimado" class="form-control" readonly>
  </div>

  <div class="form-group">
    <label for="taraReg">Tara (kg)</label>
    <input type="number" id="taraReg" name="tara" class="form-control" readonly>
  </div>

  <div class="form-group">
    <label for="confirmarTara">Confirmar Tara</label>
    <select name="confirmarTara" id="confirmarTara" class="form-control" onchange="toggleTara()">
      <option value="SI" selected>Sí</option>
      <option value="NO">No</option>
    </select>
  </div>

  <div class="form-group" id="taraNuevaField" style="display:none;">
    <label for="taraNuevaReg">Tara Nueva (kg)</label>
    <input type="number" id="taraNuevaReg" name="taraNueva" class="form-control">
  </div> 

  <div class="form-group">
    <label for="confirmarBruto">Confirmar Bruto</label>
    <select id="confirmarBruto" name="confirmarBruto" class="form-control" onchange="toggleBruto()">
      <option value="SI">Sí</option>
      <option value="NO">No</option>
    </select>
  </div>

  <div id="brutoField" class="form-group" style="display:none;">
    <label for="bruto">Bruto (kg)</label>
    <input type="number" id="bruto" name="bruto" class="form-control">
  </div>

  <input type="hidden" name="code" value="<%= code %>">
  <button type="submit" class="btn btn-primary">Confirmar</button>
</form>

<script>
  // Publicamos datos siembra para combos dependientes
  window.datosSiembra = <%- JSON.stringify(datosSiembra) %>;

  function toggleForm() {
    const val = document.getElementById('pesadaPara').value;
    document.getElementById('formTara').style.display       = val === 'TARA' ? 'block' : 'none';
    document.getElementById('formTaraFinal').style.display  = val === 'TARA_FINAL' ? 'block' : 'none';
    document.getElementById('formRegulada').style.display   = val === 'REGULADA' ? 'block' : 'none';
  }
  function toggleSocio() {
    const v = document.getElementById('cargaPara').value;
    document.getElementById('socioField').style.display = v === 'SOCIO' ? 'block' : 'none';
    document.getElementById('socio').required = v === 'SOCIO';
  }
  function toggleCargo() {
    const v = document.getElementById('cargoDe').value;
    document.getElementById('silobolsaField').style.display   = v === 'SILOBOLSA' ? 'block' : 'none';
    document.getElementById('contratistaField').style.display = v === 'CONTRATISTA' ? 'block' : 'none';
  }
  function toggleBruto() {
    const show = document.getElementById('confirmarBruto').value === 'NO';
    document.getElementById('brutoField').style.display = show ? 'block' : 'none';
  }
  function toggleTara() {
    const show = document.getElementById('confirmarTara').value === 'NO';
    document.getElementById('taraNuevaField').style.display = show ? 'block' : 'none';
    document.getElementById('taraReg').readOnly = true;
  }

  // ===== Combos dependientes en REGULADA =====
  const campoSel = document.getElementById('campo');
  const granoSel = document.getElementById('grano');
  const loteSel  = document.getElementById('lote');

  function fillGranos() {
    const campo = campoSel.value;
    granoSel.innerHTML = '<option value="">Seleccione un cultivo</option>';
    loteSel.innerHTML  = '<option value="">Seleccione un lote</option>';
    granoSel.disabled = true; loteSel.disabled = true;

    const ds = window.datosSiembra || {};
    if (campo && ds[campo]) {
      Object.keys(ds[campo]).forEach(g => {
        const op = document.createElement('option');
        op.value = op.text = g;
        granoSel.appendChild(op);
      });
      granoSel.disabled = false;
    }
  }

  function fillLotes() {
    const campo = campoSel.value;
    const grano = granoSel.value;
    loteSel.innerHTML = '<option value="">Seleccione un lote</option>';
    loteSel.disabled = true;

    const ds = window.datosSiembra || {};
    const lotes = (campo && grano && ds[campo] && ds[campo][grano]) ? ds[campo][grano] : [];
    lotes.forEach(l => {
      const op = document.createElement('option'); op.value = op.text = l;
      loteSel.appendChild(op);
    });
    if (lotes.length) loteSel.disabled = false;
  }

  campoSel.addEventListener('change', fillGranos);
  granoSel.addEventListener('change', fillLotes);

  // ===== Autocompletar BRUTO/TARA según patente elegida =====
  const patRegSel = document.getElementById('patentesRegulada');
  if (patRegSel) {
    patRegSel.addEventListener('change', function () {
      const opt   = this.options[this.selectedIndex];
      const bruto = opt?.dataset?.bruto || '';
      const tara  = opt?.dataset?.tara  || '';
      document.getElementById('brutoEstimadoReg').value = bruto;
      document.getElementById('taraReg').value          = tara;
    });
  }

  // Para TARA FINAL: completar bruto estimado y tara actual de la opción
  const patTFSel = document.getElementById('patentesTF');
  if (patTFSel) {
    patTFSel.addEventListener('change', function () {
      const opt   = this.options[this.selectedIndex];
      const bruto = opt?.dataset?.bruto || '';
      const tara  = opt?.dataset?.tara  || '';
      const brutoInp = document.getElementById('brutoEstimadoTF');
      const taraAct  = document.getElementById('taraActualTF');
      if (brutoInp) brutoInp.value = bruto;
      if (taraAct)  taraAct.value  = (tara === '' ? '—' : tara);
    });
  }

  // Estado inicial
  toggleForm();
  toggleSocio();
  toggleCargo();
  toggleBruto();
  toggleTara();
  fillGranos();
</script>

<%- include('partials/footer') %>
