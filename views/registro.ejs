<%- include('partials/header') %>
<h1>Registro de Pesaje</h1>

<!-- Selector del modo (solo visual) -->
<div class="form-group">
  <label for="modo">Pesada para</label>
  <select id="modo" class="form-control" required onchange="toggleForm()">
    <option value="">Seleccione</option>
    <option value="TARA"       <%= pesadaPara==='TARA' ? 'selected':'' %>>TARA</option>
    <option value="TARA_FINAL" <%= pesadaPara==='TARA_FINAL' ? 'selected':'' %>>TARA FINAL</option>
    <option value="REGULADA"   <%= pesadaPara==='REGULADA' ? 'selected':'' %>>REGULADA</option>
  </select>
</div>

<!-- ============================================================
     FORMULARIO TARA
     ============================================================ -->
<form action="/confirmar-tara" method="post" id="formTara"
      style="display:<%= pesadaPara==='TARA' ? 'block':'none' %>">

  <div class="form-group">
    <label for="idTicket">ID Ticket</label>
    <input type="text" id="idTicket" name="idTicket"
           class="form-control" value="<%= newIdTicket %>" readonly>
  </div>

  <div class="form-group">
    <label for="fecha">Fecha</label>
    <input type="date" id="fecha" name="fecha" class="form-control"
           value="<%= new Date().toISOString().split('T')[0] %>" readonly>
  </div>

  <div class="form-group">
    <label for="usuario">Usuario</label>
    <input type="text" id="usuario" name="usuario"
           class="form-control" value="<%= ultimoUsuario %>" required>
  </div>

  <div class="form-group">
    <label for="cargaPara">Carga para</label>
    <select id="cargaPara" name="cargaPara"
            class="form-control" required onchange="toggleSocio()">
      <option value="">Seleccione</option>
      <option value="AMH">AMH</option>
      <option value="SOCIO">SOCIO</option>
    </select>
  </div>

  <div id="socioField" class="form-group" style="display:none;">
    <label for="socio">Nombre del Socio</label>
    <input type="text" id="socio" name="socio" class="form-control">
  </div>

  <div class="form-group">
    <label for="transporte">Transporte</label>
    <input type="text" id="transporte" name="transporte"
           class="form-control" required>
  </div>

  <div class="form-group">
    <label for="patentes">Patentes</label>
    <input type="text" id="patentes" name="patentes"
           class="form-control" required>
  </div>

  <div class="form-group">
    <label for="chofer">Chofer</label>
    <input type="text" id="chofer" name="chofer"
           class="form-control" required>
  </div>

  <div class="form-group">
    <label for="brutoEstimadoTara">Bruto Estimado (kg)</label>
    <select id="brutoEstimadoTara" name="brutoEstimado"
            class="form-control" required>
      <option value="">Seleccione</option>
      <option value="45000">45000 kg</option>
      <option value="52500">52500 kg</option>
      <option value="55000">55000 kg</option>
    </select>
  </div>

  <div class="mb-3">
    <label for="tara" class="form-label">Tara (kg) (opcional)</label>
    <input type="number" id="tara" name="tara"
           class="form-control" min="0" step="1"
           placeholder="Podés dejarlo vacío si aún no la sabés">
  </div>

  <input type="hidden" name="pesadaPara" value="TARA">
  <input type="hidden" name="code" value="<%= code %>">

  <button type="submit" class="btn btn-primary">Confirmar</button>
</form>

<!-- ============================================================
     FORMULARIO TARA FINAL
     ============================================================ -->
<form action="/confirmar-tara-final" method="post" id="formTaraFinal"
      style="display:<%= pesadaPara==='TARA_FINAL' ? 'block':'none' %>">

  <div class="form-group">
    <label for="patentesTaraFinal">Patentes con TARA pendiente (sin FINAL)</label>
    <select id="patentesTaraFinal" name="patentes"
            class="form-control" required>
      <option value="">Seleccione</option>
      <% (pendientesSinFinal || []).forEach(reg => { %>
        <option value="<%= reg.patentes %>"
                data-idticket="<%= reg._id %>"
                data-bruto="<%= reg.brutoEstimado %>">
          <%= reg.patentes %> (Bruto: <%= reg.brutoEstimado %>)
        </option>
      <% }) %>
    </select>

    <% if (!(pendientesSinFinal && pendientesSinFinal.length)) { %>
      <small class="text-muted">No hay TARA pendientes.</small>
    <% } %>
  </div>

  <div class="form-group">
    <label for="taraNueva">Tara Final (kg)</label>
    <input type="number" id="taraNueva" name="taraNueva"
           class="form-control" min="0" required>
  </div>

  <input type="hidden" id="idTicketTaraFinal" name="idTicketTaraFinal">
  <input type="hidden" name="pesadaPara" value="TARA_FINAL">
  <input type="hidden" name="code" value="<%= code %>">

  <button type="submit" class="btn btn-primary">Confirmar</button>
</form>

<!-- ============================================================
     FORMULARIO REGULADA
     ============================================================ -->
<form action="/confirmar-regulada" method="post" id="formRegulada"
      style="display:<%= pesadaPara==='REGULADA' ? 'block':'none' %>">

  <div class="form-group">
    <label for="patentesRegulada">Patentes con TARA FINAL</label>
    <select id="patentesRegulada" name="patentes"
            class="form-control" required>
      <option value="">Seleccione</option>
      <% (patentesConFinal || []).forEach(reg => { %>
        <option value="<%= reg.patentes %>"
                data-idticket="<%= reg._id %>"
                data-bruto="<%= reg.brutoEstimado %>"
                data-tara="<%= reg.tara %>">
          <%= reg.patentes %> (TARA FINAL)
        </option>
      <% }) %>
    </select>

    <% if (!(pendientesConFinal && pendientesConFinal.length)) { %>
      <small class="text-muted">No hay TARA FINAL disponibles.</small>
    <% } %>
  </div>

  <!-- DETIENE ACA —>>> SEGUIR CON PARTE 2 -->
     <div class="form-group">
    <label for="campo">Campo</label>
    <select id="campo" name="campo" class="form-control" required>
      <option value="">Seleccione un campo</option>
      <% (campos || []).forEach(c => { %>
        <option value="<%= c %>"><%= c %></option>
      <% }) %>
    </select>
  </div>

  <div class="form-group">
    <label for="grano">Grano / Cultivo</label>
    <select id="grano" name="grano" class="form-control" required disabled>
      <option value="">Seleccione un cultivo</option>
    </select>
  </div>

  <div class="form-group">
    <label for="lote">Lote</label>
    <select id="lote" name="lote" class="form-control" required disabled>
      <option value="">Seleccione un lote</option>
    </select>
  </div>

  <div class="form-group">
    <label for="cargoDe">Cargo de</label>
    <select id="cargoDe" name="cargoDe" class="form-control" required onchange="toggleCargo()">
      <option value="">Seleccione</option>
      <option value="SILOBOLSA">Silobolsa</option>
      <option value="CONTRATISTA">Contratista</option>
    </select>
  </div>

  <div id="silobolsaField" class="form-group" style="display:none;">
    <label for="silobolsa">Número Silobolsa</label>
    <input type="text" id="silobolsa" name="silobolsa" class="form-control">
  </div>

  <div id="contratistaField" class="form-group" style="display:none;">
    <label for="contratista">Nombre Contratista</label>
    <input type="text" id="contratista" name="contratista" class="form-control">
  </div>

  <div class="form-group">
    <label for="brutoLote">Bruto LOTE (kg)</label>
    <input type="number" id="brutoLote" name="brutoLote"
           class="form-control" min="0" required>
    <div class="form-text">Dato informativo del lote.</div>
  </div>

  <div class="form-group">
    <label for="brutoEstimadoReg">Bruto Estimado (kg)</label>
    <input type="number" id="brutoEstimadoReg" name="brutoEstimado"
           class="form-control" readonly>
  </div>

  <div class="form-group">
    <label for="taraReg">Tara (kg)</label>
    <input type="number" id="taraReg" name="tara"
           class="form-control" readonly>
  </div>

  <div class="form-group">
    <label for="confirmarTara">Confirmar Tara</label>
    <select id="confirmarTara" name="confirmarTara"
            class="form-control" onchange="toggleTara()">
      <option value="SI" selected>Sí</option>
      <option value="NO">No</option>
    </select>
  </div>

  <div id="taraNuevaField" class="form-group" style="display:none;">
    <label for="taraNueva">Tara Nueva (kg)</label>
    <input type="number" id="taraNueva" name="taraNueva"
           class="form-control">
  </div>

  <div class="form-group">
    <label for="confirmarBruto">Confirmar Bruto</label>
    <select id="confirmarBruto" name="confirmarBruto"
            class="form-control" onchange="toggleBruto()">
      <option value="SI">Sí</option>
      <option value="NO">No</option>
    </select>
  </div>

  <div id="brutoField" class="form-group" style="display:none;">
    <label for="bruto">Bruto (kg)</label>
    <input type="number" id="bruto" name="bruto" class="form-control">
  </div>

  <div class="form-group">
    <label for="comentarios">Comentarios</label>
    <textarea id="comentarios" name="comentarios" class="form-control"
              rows="2"></textarea>
  </div>

  <input type="hidden" id="idTicketOrigen" name="idTicketOrigen" value="">
  <input type="hidden" name="pesadaPara" value="REGULADA">
  <input type="hidden" name="code" value="<%= code %>">

  <button type="submit" class="btn btn-primary">Confirmar</button>
</form>

<script>
  window.datosSiembra = <%- JSON.stringify(datosSiembra) %>;

  function toggleForm() {
    const v = document.getElementById('modo').value;
    document.getElementById('formTara').style.display =
      v === 'TARA' ? 'block' : 'none';
    document.getElementById('formTaraFinal').style.display =
      v === 'TARA_FINAL' ? 'block' : 'none';
    document.getElementById('formRegulada').style.display =
      v === 'REGULADA' ? 'block' : 'none';
  }

  function toggleSocio() {
    const v = document.getElementById('cargaPara').value;
    const show = v === 'SOCIO';
    document.getElementById('socioField').style.display = show ? 'block' : 'none';
    document.getElementById('socio').required = show;
  }

  function toggleCargo() {
    const v = document.getElementById('cargoDe').value;
    document.getElementById('silobolsaField').style.display = v === 'SILOBOLSA';
    document.getElementById('contratistaField').style.display = v === 'CONTRATISTA';
  }

  function toggleTara() {
    const show = document.getElementById('confirmarTara').value === 'NO';
    document.getElementById('taraNuevaField').style.display = show;
  }

  function toggleBruto() {
    const show = document.getElementById('confirmarBruto').value === 'NO';
    document.getElementById('brutoField').style.display = show;
  }

  const campoSel = document.getElementById('campo');
  const granoSel = document.getElementById('grano');
  const loteSel  = document.getElementById('lote');

  campoSel.addEventListener('change', () => {
    const campo = campoSel.value;
    granoSel.innerHTML = '<option value="">Seleccione un cultivo</option>';
    loteSel.innerHTML  = '<option value="">Seleccione un lote</option>';
    granoSel.disabled = true;
    loteSel.disabled = true;

    const d = window.datosSiembra[campo] || {};
    Object.keys(d).forEach(gr => {
      const op = document.createElement('option');
      op.text = op.value = gr;
      granoSel.appendChild(op);
    });
    granoSel.disabled = !Object.keys(d).length;
  });

  granoSel.addEventListener('change', () => {
    const campo = campoSel.value;
    const grano = granoSel.value;
    loteSel.innerHTML = '<option value="">Seleccione un lote</option>';
    loteSel.disabled = true;

    const lotes = (window.datosSiembra[campo] || {})[grano] || [];
    lotes.forEach(lo => {
      const op = document.createElement('option');
      op.text = op.value = lo;
      loteSel.appendChild(op);
    });
    loteSel.disabled = !lotes.length;
  });

  // --- Completar datos en REGULADA
  const selReg = document.getElementById('patentesRegulada');
  selReg?.addEventListener('change', function () {
    const op = this.options[this.selectedIndex];
    document.getElementById('brutoEstimadoReg').value = op.dataset.bruto || '';
    document.getElementById('taraReg').value  = op.dataset.tara || '';
    document.getElementById('idTicketOrigen').value = op.dataset.idticket || '';
  });

  // --- Completar id en TARA FINAL
  const selTaraFinal = document.getElementById('patentesTaraFinal');
  selTaraFinal?.addEventListener('change', function () {
    const op = this.options[this.selectedIndex];
    document.getElementById('idTicketTaraFinal').value = op.dataset.idticket || '';
  });

  // Estado inicial
  toggleForm();
  toggleSocio();
  toggleCargo();
  toggleTara();
  toggleBruto();
</script>

<%- include('partials/footer') %>