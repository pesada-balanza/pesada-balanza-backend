<%- include('partials/header') %>
<h1>Registro de Pesaje</h1>

<!-- Selector de modo SOLO-UI (no se envía al backend) -->
<div class="form-group">
  <label for="modo">Pesada para</label>
  <select id="modo" class="form-control" required onchange="toggleForm()">
    <option value="">Seleccione</option>
    <option value="TARA"       <%= pesadaPara==='TARA' ? 'selected':'' %>>TARA</option>
    <option value="TARA_FINAL" <%= pesadaPara==='TARA_FINAL' ? 'selected':'' %>>TARA FINAL</option>
    <option value="REGULADA"   <%= pesadaPara==='REGULADA' ? 'selected':'' %>>REGULADA</option>
  </select>
</div>

<!-- ====== TARA ====== -->
<form action="/confirmar-tara" method="post" id="formTara" style="display:<%= pesadaPara==='TARA' ? 'block':'none' %>">
  <div class="form-group">
    <label for="idTicket">ID Ticket</label>
    <input type="text" id="idTicket" name="idTicket" class="form-control" value="<%= newIdTicket %>" readonly>
  </div>

  <div class="form-group">
    <label for="fecha">Fecha</label>
    <input type="date" id="fecha" name="fecha" class="form-control" value="<%= new Date().toISOString().split('T')[0] %>" readonly>
  </div>

  <div class="form-group">
    <label for="usuario">Usuario</label>
    <input type="text" id="usuario" name="usuario" class="form-control" value="<%= ultimoUsuario %>" required>
  </div>

  <div class="form-group">
    <label for="cargaPara">Carga para</label>
    <select id="cargaPara" name="cargaPara" class="form-control" required onchange="toggleSocio()">
      <option value="">Seleccione</option>
      <option value="AMH">AMH</option>
      <option value="SOCIO">SOCIO</option>
    </select>
  </div>

  <div id="socioField" class="form-group" style="display:none;">
    <label for="socio">Nombre del Socio</label>
    <input type="text" id="socio" name="socio" class="form-control">
  </div>

  <!-- Transporte / Patentes / Chofer -->
  <div class="form-group">
    <label for="transporte">Transporte</label>
    <input type="text" id="transporte" name="transporte" class="form-control" required>
  </div>

  <div class="form-group">
    <label for="patentes">Patentes</label>
    <input type="text" id="patentes" name="patentes" class="form-control" required>
  </div>

  <div class="form-group">
    <label for="chofer">Chofer</label>
    <input type="text" id="chofer" name="chofer" class="form-control" required>
  </div>

  <div class="form-group">
    <label for="brutoEstimadoTara">Bruto Estimado (kg)</label>
    <select id="brutoEstimadoTara" name="brutoEstimado" class="form-control" required>
      <option value="">Seleccione</option>
      <option value="45000">45000 kg</option>
      <option value="52500">52500 kg</option>
      <option value="55000">55000 kg</option>
    </select>
  </div>

  <!-- Tara (kg) - OPCIONAL al crear TARA -->
  <div class="mb-3">
    <label for="tara" class="form-label">Tara (kg)</label>
    <input
      type="number"
      id="tara"
      name="tara"
      class="form-control"
      min="0"
      step="1"
      placeholder="Podés dejarlo vacío si aún no la sabés"
      value="<%= typeof tara !== 'undefined' ? tara : '' %>"
    />
    <div class="form-text">
      Este campo es opcional al crear la TARA. Podés cargarlo después o al cerrar la REGULADA.
    </div>
  </div>

  <!-- Forzar el modo correcto para esta ruta -->
  <input type="hidden" name="pesadaPara" value="TARA">
  <input type="hidden" name="code" value="<%= code %>">

  <button type="submit" class="btn btn-primary">Confirmar</button>
</form>

<!-- ====== TARA FINAL ====== -->
<form action="/confirmar-tara-final" method="post" id="formTaraFinal" style="display:<%= pesadaPara==='TARA_FINAL' ? 'block':'none' %>">
  <div class="form-group">
    <label for="patentesTaraFinal">Patentes (solo TARA pendientes: últimos 3 días)</label>
    <select id="patentesTaraFinal" name="patentes" class="form-control" required>
      <option value="">Seleccione</option>
      <% (pendientesSinFinal || []).forEach(reg => { %>
        < option
           value="<%= reg.patentes %>"
           data-idticket="<%= reg._id %>"
           data-bruto="<%= reg.brutoEstimado %>">
          <%= reg.patentes %> (Bruto estimado: <%= reg.brutoEstimado %>)
        </option>
      <% }) %>
    </select>
    <% if (!(pendientesSinFinal && pendientesSinFinal.length)) { %>
      <small class="text-muted">No hay patentes con TARA pendiente (sin TARA FINAL) en los últimos 3 días.</small>
    <% } %>
  </div>

  <div class="form-group">
    <label for="taraNueva">Tara (kg)</label>
    <input type="number" id="taraNueva" name="taraNueva" class="form-control" min="0" step="1" required>
  </div>

  <!-- ID del ticket que se va a cerrar -->
  <input type="hidden" id="idTicketTaraFinal" name="idTicketTaraFinal" value="">
  <!-- (Opcional) marcar el modo -->
  <input type="hidden" name="pesadaPara" value="TARA_FINAL">
  <input type="hidden" name="code" value="<%= code %>">

  <button type="submit" class="btn btn-primary">Confirmar</button>
</form>

<!-- ====== REGULADA ====== -->
<form action="/confirmar-regulada" method="post" id="formRegulada" style="display:<%= pesadaPara==='REGULADA' ? 'block':'none' %>">
  <div class="form-group">
    <label for="patentesRegulada">Patentes (con TARA FINAL: últimos 3 días)</label>
    <select id="patentesRegulada" name="patentes" class="form-control" required>
      <option value="">Seleccione</option>
      <% (pendientesConFinal || []).forEach(reg => { %>
        <option
          value="<%= reg.patentes %>"
          data-idticket="<%= reg._id %>"
          data-bruto="<%= reg.brutoEstimado %>"
          data-tara="<%= reg.tara %>">
          <%= reg.patentes %> - TARA FINAL
        </option>
      <% }) %>
    </select>
    <% if (!(pendientesConFinal && pendientesConFinal.length)) { %>
      <small class="text-muted">No hay patentes con TARA FINAL en los últimos 3 días.</small>
    <% } %>
  </div>

  <div class="form-group">
    <label for="campo">Campo</label>
    <select id="campo" name="campo" class="form-control" required>
      <option value="">Seleccione un campo</option>
      <% (campos || []).forEach(c => { %>
        <option value="<%= c %>"><%= c %></option>
      <% }) %>
    </select>
  </div>

  <div class="form-group">
    <label for="grano">Grano / Cultivo</label>
    <select id="grano" name="grano" class="form-control" required disabled>
      <option value="">Seleccione un cultivo</option>
    </select>
  </div>

  <div class="form-group">
    <label for="lote">Lote</label>
    <select id="lote" name="lote" class="form-control" required disabled>
      <option value="">Seleccione un lote</option>
    </select>
  </div>

  <div class="form-group">
    <label for="cargoDe">Cargo de</label>
    <select id="cargoDe" name="cargoDe" class="form-control" required onchange="toggleCargo()">
      <option value="">Seleccione</option>
      <option value="SILOBOLSA">Silobolsa</option>
      <option value="CONTRATISTA">Contratista</option>
    </select>
  </div>

  <div id="silobolsaField" class="form-group" style="display:none;">
    <label for="silobolsa">Número Silobolsa</label>
    <input type="text" id="silobolsa" name="silobolsa" class="form-control">
  </div>

  <div id="contratistaField" class="form-group" style="display:none;">
    <label for="contratista">Nombre Contratista</label>
    <input type="text" id="contratista" name="contratista" class="form-control">
  </div>

  <!-- Bruto LOTE (obligatorio, informativo) -->
  <div class="form-group">
    <label for="brutoLote">Bruto LOTE (kg)</label>
    <input type="number" id="brutoLote" name="brutoLote" class="form-control" min="0" step="1" required>
    <div class="form-text">Dato informativo del lote. No afecta cálculos.</div>
  </div>

  <div class="form-group">
    <label for="brutoEstimadoReg">Bruto Estimado (kg)</label>
    <input type="text" id="brutoEstimadoReg" name="brutoEstimado" class="form-control" readonly>
  </div>

  <div class="form-group">
    <label for="taraReg">Tara (kg)</label>
    <input type="number" id="taraReg" name="tara" class="form-control" readonly>
  </div>

  <div class="form-group">
    <label for="confirmarTara">Confirmar Tara</label>
    <select name="confirmarTara" id="confirmarTara" class="form-control" onchange="toggleTara()">
      <option value="SI" selected>Sí</option>
      <option value="NO">No</option>
    </select>
  </div>

  <div class="form-group" id="taraNuevaField" style="display:none;">
    <label for="taraNueva">Tara Nueva (kg)</label>
    <input type="number" id="taraNueva" name="taraNueva" class="form-control">
  </div>

  <div class="form-group">
    <label for="confirmarBruto">Confirmar Bruto</label>
    <select id="confirmarBruto" name="confirmarBruto" class="form-control" onchange="toggleBruto()">
      <option value="SI">Sí</option>
      <option value="NO">No</option>
    </select>
  </div>

  <div id="brutoField" class="form-group" style="display:none;">
    <label for="bruto">Bruto (kg)</label>
    <input type="number" id="bruto" name="bruto" class="form-control">
  </div>

  <!-- Comentarios (opcional) -->
  <div class="form-group">
    <label for="comentarios">Comentarios</label>
    <textarea id="comentarios" name="comentarios" class="form-control" rows="2" placeholder="Observaciones del balancero (opcional)"></textarea>
  </div>

  <!-- ID del ticket TARA origen -->
  <input type="hidden" id="idTicketOrigen" name="idTicketOrigen" value="">
  <!-- (Opcional) marcar el modo -->
  <input type="hidden" name="pesadaPara" value="REGULADA">
  <input type="hidden" name="code" value="<%= code %>">

  <button type="submit" class="btn btn-primary">Confirmar</button>
</form>

<script>
  // Datos siembra para combos dependientes
  window.datosSiembra = <%- JSON.stringify(datosSiembra) %>;

  function toggleForm() {
    const val = document.getElementById('modo').value;
    document.getElementById('formTara').style.display      = (val === 'TARA') ? 'block' : 'none';
    document.getElementById('formTaraFinal').style.display = (val === 'TARA_FINAL') ? 'block' : 'none';
    document.getElementById('formRegulada').style.display  = (val === 'REGULADA') ? 'block' : 'none';
  }
  function toggleSocio() {
    const v = document.getElementById('cargaPara').value;
    document.getElementById('socioField').style.display = v === 'SOCIO' ? 'block' : 'none';
    document.getElementById('socio').required = v === 'SOCIO';
  }
  function toggleCargo() {
    const v = document.getElementById('cargoDe').value;
    document.getElementById('silobolsaField').style.display   = v === 'SILOBOLSA' ? 'block' : 'none';
    document.getElementById('contratistaField').style.display = v === 'CONTRATISTA' ? 'block' : 'none';
  }
  function toggleBruto() {
    const show = document.getElementById('confirmarBruto').value === 'NO';
    document.getElementById('brutoField').style.display = show ? 'block' : 'none';
  }
  function toggleTara() {
    const show = document.getElementById('confirmarTara').value === 'NO';
    document.getElementById('taraNuevaField').style.display = show ? 'block' : 'none';
    const taraReg = document.getElementById('taraReg');
    if (taraReg) taraReg.readOnly = true;
  }

  const campoSel = document.getElementById('campo');
  const granoSel = document.getElementById('grano');
  const loteSel  = document.getElementById('lote');

  function fillGranos() {
    const campo = campoSel.value;
    granoSel.innerHTML = '<option value="">Seleccione un cultivo</option>';
    loteSel.innerHTML  = '<option value="">Seleccione un lote</option>';
    granoSel.disabled = true; loteSel.disabled = true;

    const ds = window.datosSiembra || {};
    if (campo && ds[campo]) {
      Object.keys(ds[campo]).forEach(g => {
        const op = document.createElement('option');
        op.value = op.text = g;
        granoSel.appendChild(op);
      });
      granoSel.disabled = false;
    }
  }

  function fillLotes() {
    const campo = campoSel.value;
    const grano = granoSel.value;
    loteSel.innerHTML = '<option value="">Seleccione un lote</option>';
    loteSel.disabled = true;

    const ds = window.datosSiembra || {};
    const lotes = (campo && grano && ds[campo] && ds[campo][grano]) ? ds[campo][grano] : [];
    lotes.forEach(l => {
      const op = document.createElement('option'); op.value = op.text = l;
      loteSel.appendChild(op);
    });
    if (lotes.length) loteSel.disabled = false;
  }

  // Completar bruto/tara + setear idTicket en REGULADA
  const patSel = document.getElementById('patentesRegulada');
  if (patSel) {
    patSel.addEventListener('change', function () {
      const opt   = this.options[this.selectedIndex];
      const bruto = opt?.dataset?.bruto || '';
      const tara  = opt?.dataset?.tara  || '';
      const idtk  = opt?.dataset?.idticket || '';
      const brutoInput = document.getElementById('brutoEstimadoReg');
      const taraInput  = document.getElementById('taraReg');
      const idInput    = document.getElementById('idTicketOrigen');
      if (brutoInput) brutoInput.value = bruto;
      if (taraInput)  taraInput.value  = tara;
      if (idInput)    idInput.value    = idtk;
    });
  }

  // Setear hidden id del ticket en TARA FINAL
  const patTaraFinalSel = document.getElementById('patentesTaraFinal');
  if (patTaraFinalSel) {
    patTaraFinalSel.addEventListener('change', function(){
      const opt  = this.options[this.selectedIndex];
      const idtk = opt?.dataset?.idticket || '';
      const hid  = document.getElementById('idTicketTaraFinal');
      if (hid) hid.value = idtk;
    });
  }

  if (campoSel) campoSel.addEventListener('change', fillGranos);
  if (granoSel) granoSel.addEventListener('change', fillLotes);

  // Estado inicial
  toggleForm(); toggleSocio(); toggleCargo(); toggleBruto(); toggleTara();
  fillGranos();
</script>

<%- include('partials/footer') %>
