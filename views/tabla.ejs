<%- include('partials/header') %>
<h1>Tabla de Registros</h1>

<style>
  /* contenedor con scroll propio */
  .table-scroll {
    /* ajustá esta altura si te queda muy alto/bajo */
    max-height: calc(100vh - 260px);
    overflow: auto;
    border: 1px solid #eee;
    border-radius: .25rem;
  }

  /* encabezado pegajoso dentro del contenedor */
  .table-scroll thead th {
    position: sticky;
    top: 0;                 /* se pega al tope del contenedor con scroll */
    background: #fff;       /* que no se vea transparente al pasar filas */
    z-index: 2;             /* por encima de las filas */
    box-shadow: 0 2px 0 rgba(0,0,0,.04);
  }

  /* (opcional) fijar también la primera columna
  .table-scroll td:first-child,
  .table-scroll th:first-child {
    position: sticky;
    left: 0;
    z-index: 3;
    background: #fff;
    box-shadow: 2px 0 0 rgba(0,0,0,.04);
  }
  */
</style>

<!-- Barra de acciones / filtros -->
<div class="d-flex align-items-end gap-2 mb-3">
  <!-- Filtro por fechas (GET) -->
  <form class="d-flex align-items-end gap-2" method="get" action="/tabla">
    <input type="hidden" name="code" value="<%= observacionCode %>">

    <div>
      <label for="from" class="form-label mb-0">Desde</label>
      <input type="date" id="from" name="from" class="form-control"
             value="<%= (range && range.from) ? range.from : '' %>">
    </div>

    <div>
      <label for="to" class="form-label mb-0">Hasta</label>
      <input type="date" id="to" name="to" class="form-control"
             value="<%= (range && range.to) ? range.to : '' %>">
    </div>

    <button type="submit" class="btn btn-info">Filtrar</button>

    <!-- Atajo rápido a HOY -->
    <a class="btn btn-outline-secondary"
       href="/tabla?code=<%= observacionCode %>">Hoy</a>
  </form>

  <!-- Exportar a Excel respetando el filtro actual -->
  <a href="/export?code=<%= observacionCode %><% if (range && range.from) { %>&from=<%= range.from %><% } %><% if (range && range.to) { %>&to=<%= range.to %><% } %>"
     class="btn btn-success ms-auto">Exportar a Excel</a>
</div>

<!-- Rango mostrado -->
<% if (range && range.from && range.to) { %>
  <p class="text-muted">
    Mostrando registros entre <strong><%= range.from %></strong> y <strong><%= range.to %></strong>.
  </p>
<% } else { %>
  <p class="text-muted">Mostrando registros de hoy.</p>
<% } %>

<div class="table-scroll">
  <table class="table">
  <thead>
    <tr>
      <th>ID Ticket</th>
      <th>Fecha</th>
      <th>Usuario</th>
      <th>Carga Para</th>
      <th>Socio</th>
      <th>Pesada Para</th>
      <th>Transporte</th>
      <th>Patentes</th>
      <th>Chofer</th>
      <th>Bruto Estimado</th>
      <th>Tara</th>
      <th>Neto Estimado</th>
      <th>Campo</th>
      <th>Grano</th>
      <th>Lote</th>
      <th>Cargo De</th>
      <th>Silobolsa</th>
      <th>Contratista</th>
      <th>Bruto LOTE</th>       <!-- NUEVO -->
      <th>Comentarios</th>      <!-- NUEVO -->
      <th>Bruto</th>
      <th>Neto</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
  <% registros.forEach(function(registro){ %>
    <%
      const hoy00 = new Date(new Date().setHours(0,0,0,0));
      const fechaPasada = new Date(registro.fecha) < hoy00;
      let estilo = '';
      if (registro.anulado) {
        estilo = 'background-color:#f8d7da !important;';   // rojo suave
      } else if ((registro.modificaciones || 0) > 0) {
        estilo = 'background-color:#fff3cd !important;';   // amarillo suave
      } else if (fechaPasada) {
        estilo = 'background-color:#ffe5cc !important;';   // naranja suave
      }
    %>
    <tr style="<%= estilo %>">
      <td><%= registro.idTicket %></td>
      <td><%= registro.fecha %></td>
      <td><%= registro.usuario %></td>
      <td><%= registro.cargaPara %></td>
      <td><%= registro.socio || '' %></td>
      <td><%= registro.pesadaPara %></td>
      <td><%= registro.transporte || '' %></td>
      <td><%= registro.patentes %></td>
      <td><%= registro.chofer || '' %></td>
      <td><%= (typeof registro.brutoEstimado === 'number') ? registro.brutoEstimado : (registro.brutoEstimado ?? '') %></td>
      <td><%= (typeof registro.tara === 'number') ? registro.tara : (registro.tara ?? '') %></td>
      <td><%= (typeof registro.netoEstimado === 'number') ? registro.netoEstimado : (registro.netoEstimado ?? '') %></td>
      <td><%= registro.campo || '' %></td>
      <td><%= registro.grano || '' %></td>
      <td><%= registro.lote || '' %></td>
      <td><%= registro.cargoDe || '' %></td>
      <td><%= registro.silobolsa || '' %></td>
      <td><%= registro.contratista || '' %></td>
      <td><%= (typeof registro.brutoLote === 'number') ? registro.brutoLote : (registro.brutoLote ?? '') %></td> <!-- NUEVO -->
      <td><%= registro.comentarios || '' %></td> <!-- NUEVO -->
      <td><%= (typeof registro.bruto === 'number') ? registro.bruto : (registro.bruto ?? '') %></td>
      <td>
        <% if (typeof registro.neto === 'number') { %>
          <%= registro.neto %>
        <% } else if (typeof registro.bruto === 'number') { %>
          <%= registro.bruto - (registro.tara || 0) %>
        <% } else { %>
          <!-- vacío -->
        <% } %>
      </td>
      <td>
        <% if (!registro.anulado) { %>
          <a href="/modificar/<%= registro._id %>?code=9999" class="btn btn-warning btn-sm">Modificar</a>
          <form action="/anular/<%= registro._id %>?code=<%= observacionCode %>" method="post" style="display:inline;">
            <input type="hidden" name="_method" value="PUT">
            <button type="submit" class="btn btn-danger btn-sm">Anular</button>
          </form>
        <% } else { %>
          <span class="text-danger">Anulado</span>
        <% } %>
      </td>
    </tr>
  <% }) %>
  </tbody>
</table>
</div>

<%- include('partials/footer') %>
